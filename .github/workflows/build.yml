---
name: CI
on:
  push:
    branches:
      - master
  pull_request:
    types: [opened, synchronize, reopened]
jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - run: |
          git clone https://github.com/lean-delivery/ansible-lint-rules.git ~/ansible-lint-rules
          yamllint . -c .yamllint
          ansible-lint . -c .ansible-lint
          rm -rf ~/ansible-lint-rules
  sonarqube-latest:
    runs-on: ubuntu-latest
    container: leandelivery/docker-ansible-ci:ansible-2.9
    env:
      TEST: default
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - name: Prepare
        run: |
          if [[ ${GITHUB_HEAD_REF} == dependabot* ]]; then echo 'Skipping test for dependabot branch' && exit 0; fi
          ansible --version
          ansible-lint --version
          molecule --version
          rm -rf molecule/resources/provisioning
          git clone https://github.com/lean-delivery/ansible-molecule-drivers.git molecule/resources/provisioning
          pip install jmespath
          apk add --no-cache docker # temp fix
      - name: Molecule
        run: molecule test -s ${TEST}
  sonarqube-7.9.5:
    runs-on: ubuntu-latest
    container: leandelivery/docker-ansible-ci:ansible-2.9
    env:
      TEST: sonarqube-7.9.5
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - name: Prepare
        run: |
          if [[ ${GITHUB_HEAD_REF} == dependabot* ]]; then echo 'Skipping test for dependabot branch' && exit 0; fi
          ansible --version
          ansible-lint --version
          molecule --version
          rm -rf molecule/resources/provisioning
          git clone https://github.com/lean-delivery/ansible-molecule-drivers.git molecule/resources/provisioning
          pip install jmespath
          apk add --no-cache docker # temp fix
      - name: Molecule
        run: molecule test -s ${TEST}
