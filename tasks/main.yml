---
# tasks file for sonarqube

- name: "(Install: RPM OSs) Set Default RPM NGINX Signing Key"
  set_fact:
    default_keysite: >-
      {{ (ansible_distribution_major_version|int == 6)
      | ternary('http://nginx.org/keys/nginx_signing.key', 'https://nginx.org/keys/nginx_signing.key') }}

- name: "(Install: RPM OSs) Set RPM NGINX Signing Key URL"
  set_fact:
    keysite: "{{ nginx_signing_key | default(default_keysite) }}"

- name: "(Install: RPM OSs) Add RPM NGINX Signing Key"
  rpm_key:
    key: "{{ keysite }}"

- name: "(Install: CentOS/RedHat) Add NGINX Repository"
  yum_repository:
    name: nginx
    baseurl: https://nginx.org/packages/mainline/centos/7/$basearch/
    description: NGINX Repository
    enabled: true
    gpgcheck: true

- name: "(Install: CentOS/RedHat) Install NGINX"
  yum:
    name: nginx
    state: present
  register: install_result
  until: install_result is succeeded
  retries: 3
  delay: 5

- name: Choose platform based task
  include_tasks: '{{ platform }}'
  with_first_found:
    - 'system/{{ ansible_facts.system }}.yml'
    - 'system/not-supported.yml'
  loop_control:
    loop_var: platform
